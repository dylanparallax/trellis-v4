// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model School {
  id                String   @id @default(cuid())
  name              String
  district          String?
  settings          Json     @default("{}")
  evaluationFramework Json   // School's rubric/framework
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  users             User[]
  teachers          Teacher[]
  observations      Observation[]
  evaluations       Evaluation[]
}

model User {
  id                String   @id @default(cuid())
  email             String   @unique
  name              String
  role              Role     @default(EVALUATOR)
  schoolId          String
  school            School   @relation(fields: [schoolId], references: [id])
  // Optional link to Teacher record when this user is a teacher
  teacherId         String?
  teacher           Teacher? @relation(fields: [teacherId], references: [id])
  
  observations      Observation[]
  evaluations       Evaluation[]
  createdAt         DateTime @default(now())

  @@unique([teacherId])
}

enum Role {
  ADMIN
  EVALUATOR
  DISTRICT_ADMIN
  TEACHER
}

model Teacher {
  id                String   @id @default(cuid())
  name              String
  email             String?  @unique
  subject           String?
  gradeLevel        String?
  photoUrl          String?  // URL to teacher's photo
  schoolId          String
  school            School   @relation(fields: [schoolId], references: [id])
  // Back-reference to User when the teacher has a login
  user              User?
  
  // Performance tracking
  performanceHistory Json    @default("[]")
  currentGoals      Json     @default("[]")
  strengths         String   @default("[]") // JSON string for SQLite
  growthAreas       String   @default("[]") // JSON string for SQLite
  departments       String   @default("[]") // JSON string for SQLite
  tenureStatus      TenureStatus?
  
  observations      Observation[]
  evaluations       Evaluation[]
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model Observation {
  id                String   @id @default(cuid())
  teacherId         String
  teacher           Teacher  @relation(fields: [teacherId], references: [id])
  observerId        String
  observer          User     @relation(fields: [observerId], references: [id])
  schoolId          String
  school            School   @relation(fields: [schoolId], references: [id])
  
  // Raw observation data
  rawNotes          String
  enhancedNotes     String?
  
  // Structured data
  date              DateTime
  duration          Int?     // minutes
  observationType   ObservationType
  subject           String?
  focusAreas        String   @default("[]") // JSON string for SQLite
  
  // RAG/Embedding fields
  embedding         String?  // JSON string of embedding vector for SQLite
  embeddingText     String?  // Combined text used for embedding
  embeddingVersion  String?  // Track embedding model version
  embeddedAt        DateTime? // When embedding was generated
  
  artifacts         ObservationArtifact[]
  createdAt         DateTime @default(now())
  
  @@index([teacherId])
  @@index([schoolId, createdAt])
}

enum ObservationType {
  FORMAL
  INFORMAL
  WALKTHROUGH
  OTHER
}

enum TenureStatus {
  TEMPORARY
  PROBATIONARY
  PERMANENT
}

model ObservationArtifact {
  id                String   @id @default(cuid())
  observationId     String
  observation       Observation @relation(fields: [observationId], references: [id])
  
  fileName          String
  fileUrl           String
  fileType          String
  ocrText           String?
  processedData     Json?
  
  createdAt         DateTime @default(now())
}

model Evaluation {
  id                String   @id @default(cuid())
  teacherId         String
  teacher           Teacher  @relation(fields: [teacherId], references: [id])
  evaluatorId       String
  evaluator         User     @relation(fields: [evaluatorId], references: [id])
  schoolId          String
  school            School   @relation(fields: [schoolId], references: [id])
  
  type              EvaluationType
  status            EvaluationStatus @default(DRAFT)
  
  // Content
  content           Json     // Structured evaluation data
  summary           String?
  recommendations   String   @default("[]") // JSON string for SQLite
  nextSteps         String   @default("[]") // JSON string for SQLite
  
  // Metrics (based on school framework)
  scores            Json
  
  // RAG/Embedding fields
  embedding         String?  // JSON string of embedding vector for SQLite
  embeddingText     String?  // Combined text used for embedding
  embeddingVersion  String?  // Track embedding model version
  embeddedAt        DateTime? // When embedding was generated
  
  submittedAt       DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@index([teacherId])
  @@index([schoolId, createdAt])
}

enum EvaluationType {
  FORMATIVE
  SUMMATIVE
  MID_YEAR
  END_YEAR
}

enum EvaluationStatus {
  DRAFT
  SUBMITTED
  ACKNOWLEDGED
} 